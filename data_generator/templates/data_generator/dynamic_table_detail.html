{% extends 'data_generator/base.html' %}

{% block title %}{{ table_def.display_name }} - Dynamic Table{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-table"></i> {{ table_def.display_name }}</h2>
    <div>
        <a href="{% url 'dynamic_table_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Tables
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-columns"></i> Table Structure</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Field Name</th>
                                <th>Data Type</th>
                                <th>AI Description</th>
                                <th>Options</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in table_def.fields_definition %}
                                <tr>
                                    <td><code>{{ field.name }}</code></td>
                                    <td>
                                        <span class="badge bg-info">{{ field.type|title }}</span>
                                    </td>
                                    <td>
                                        {% if field.options.ai_description %}
                                            <small class="text-info">{{ field.options.ai_description|truncatechars:50 }}</small>
                                        {% else %}
                                            <span class="text-muted">Standard generation</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if field.options.max_length %}
                                                Max: {{ field.options.max_length }}
                                            {% endif %}
                                            {% if field.options.min_value %}
                                                Min: {{ field.options.min_value }}
                                            {% endif %}
                                            {% if field.options.max_value %}
                                                Max: {{ field.options.max_value }}
                                            {% endif %}
                                            {% if field.options.choices %}
                                                Choices: {{ field.options.choices|join:", "|truncatechars:30 }}
                                            {% endif %}
                                            {% if field.options.nullable %}
                                                <span class="badge bg-warning">Nullable</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr class="table-secondary">
                                <td><code>id</code></td>
                                <td><span class="badge bg-primary">AutoField</span></td>
                                <td><span class="text-muted">N/A</span></td>
                                <td><small>Primary Key (auto-generated)</small></td>
                            </tr>
                            <tr class="table-secondary">
                                <td><code>created_at</code></td>
                                <td><span class="badge bg-primary">DateTime</span></td>
                                <td><span class="text-muted">N/A</span></td>
                                <td><small>Timestamp (auto-generated)</small></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        {% if recent_exports %}
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Recent Exports</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Export #</th>
                                    <th>Records</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for export in recent_exports %}
                                    <tr>
                                        <td>#{{ export.id }}</td>
                                        <td>{{ export.num_records }}</td>
                                        <td>
                                            {% if export.status == 'completed' %}
                                                <span class="badge bg-success">{{ export.get_status_display }}</span>
                                            {% elif export.status == 'processing' %}
                                                <span class="badge bg-warning">{{ export.get_status_display }}</span>
                                            {% elif export.status == 'failed' %}
                                                <span class="badge bg-danger">{{ export.get_status_display }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ export.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ export.created_at|date:"M d, H:i" }}</td>
                                        <td>
                                            {% if export.status == 'completed' %}
                                                <a href="{% url 'download_excel' export.id %}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-download"></i> Download
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info"></i> Table Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Display Name:</strong> {{ table_def.display_name }}</p>
                <p><strong>Database Table:</strong> <code>{{ table_def.table_name }}</code></p>
                <p><strong>Description:</strong> {{ table_def.description|default:"No description provided" }}</p>
                
                <hr>
                
                <p><strong>Created:</strong> {{ table_def.created_at|date:"M d, Y H:i" }}</p>
                <p><strong>Migration Status:</strong> 
                    {% if table_def.is_migrated %}
                        <span class="badge bg-success">Migrated</span>
                    {% else %}
                        <span class="badge bg-danger">Not Migrated</span>
                    {% endif %}
                </p>
                {% if table_def.migration_file %}
                    <p><strong>Migration File:</strong> <code>{{ table_def.migration_file }}</code></p>
                {% endif %}
                <p><strong>Total Exports:</strong> {{ table_def.exports.count }}</p>
            </div>
        </div>
        
        {% if table_def.is_migrated %}
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-excel"></i> Generate Excel Data</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'generate_excel_data' table_def.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="num_records" class="form-label">Number of Records</label>
                            <input type="number" class="form-control" id="num_records" 
                                   name="num_records" value="5" min="1" max="10" required>
                            <div class="form-text">Maximum 10 records per export</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="openai_api_key" class="form-label">OpenAI API Key</label>
                            {% if has_env_api_key %}
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check-circle"></i>
                                    <strong>API Key Found in .env File!</strong> 
                                    Using OPENAI_API_KEY from backend configuration. You can leave this field empty.
                                </div>
                                <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" 
                                       placeholder="Leave empty to use environment variable (optional override)">
                            {% else %}
                                <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" 
                                       placeholder="sk-..." required>
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Required for AI-enhanced data generation. 
                                    <a href="https://platform.openai.com/api-keys" target="_blank">Get your API key here</a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="save_to_db" id="save_to_db">
                                <label class="form-check-label" for="save_to_db">
                                    Also save data to database
                                </label>
                                <div class="form-text">Data will be inserted into the {{ table_def.table_name }} table</div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="submit-btn">
                                <i class="fas fa-magic"></i> Generate & Export Excel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- HTMX Progress Bar Container (below the Generate Excel Data card) -->
            <div id="progress-container" class="mt-3" style="display: none;">
                <!-- Progress will be loaded here via HTMX -->
            </div>
        {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Table Not Migrated</h5>
                    <p class="text-muted">This table needs to be migrated before you can generate data.</p>
                    <p class="text-muted">Migration status: {{ table_def.is_migrated }}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% if table_def.fields_definition %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> Raw Field Definition (JSON)</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>{{ fields_json }}</code></pre>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    const progressContainer = document.getElementById('progress-container');
    
    if (form && submitBtn && progressContainer) {
        form.addEventListener('submit', function(e) {
            // Show progress container immediately
            progressContainer.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Show initial progress message
            progressContainer.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Starting data generation...</span>
                    <span class="text-muted">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <small class="text-muted">
                        <i class="fas fa-spinner fa-spin"></i>
                        Initializing...
                    </small>
                </div>
            `;
            
            // Start polling for progress updates
            let progressInterval = setInterval(function() {
                // Try to get the latest export ID from the URL or use a placeholder
                // Since we can't easily get the export ID from a regular form submission,
                // we'll simulate progress for now
                const progressBar = progressContainer.querySelector('.progress-bar');
                const progressText = progressContainer.querySelector('.text-muted');
                const percentageSpan = progressContainer.querySelectorAll('.text-muted')[1];
                
                if (progressBar && progressText && percentageSpan) {
                    let currentProgress = parseInt(progressBar.style.width) || 0;
                    currentProgress += Math.random() * 10; // Random increment
                    if (currentProgress > 90) currentProgress = 90; // Don't go to 100% until actually done
                    
                    progressBar.style.width = currentProgress + '%';
                    progressBar.setAttribute('aria-valuenow', currentProgress);
                    percentageSpan.textContent = Math.round(currentProgress) + '%';
                    
                    // Update progress bar color based on progress
                    if (currentProgress < 30) {
                        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
                        progressText.textContent = 'Generating synthetic data...';
                    } else if (currentProgress < 70) {
                        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
                        progressText.textContent = 'Creating Excel file...';
                    } else {
                        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-success';
                        progressText.textContent = 'Finalizing export...';
                    }
                }
            }, 500); // Update every 500ms
            
            // Store interval ID to clear it if needed
            form.dataset.progressInterval = progressInterval;
        });
    }
});
</script>
